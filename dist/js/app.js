var app=angular.module("PublicTransportation",["ngMaterial","ngMessages","md.data.table"]);app.controller("appCtrl",["$scope","$rootScope","$mdToast","$document","$timeout","$q","$element","$window",function(e,t,n,a,r,o,s,l){function p(){var t=window.indexedDB.open(e.dbName);t.onerror=function(e){alert("open error")},t.onsuccess=function(t){console.log("event"),e.buttonText="Trip Planner",e.buttonReady=!0,e.$apply()},t.onupgradeneeded=function(t){e.buttonText="Loading FirstTime Data",e.$apply();var n=t.target.result,a={keyPath:"RecordID",autoIncrement:!0};try{n.deleteObjectStore("TrainStopTimes")}catch(i){console.log("err")}try{oStore=n.createObjectStore("TrainStopTimes",a);var r={unique:!1,multientry:!1};oStore.createIndex("tripIdTrainStopTimes","tripId",r),oStore.createIndex("arrivalTimeTrainStopTimes","arrivalTime",r),oStore.createIndex("departureTimeTrainStopTimes","departureTime",r),oStore.createIndex("stopIdTrainStopTimes","stopId",r),oStore.createIndex("stopSequenceTrainStopTimes","stopSequence",r),oStore.createIndex("compound1",["tripId","stopId"],r);for(var o in stopTimes)var s=oStore.add(stopTimes[o])}catch(i){console.log("someError")}}}function u(){e.results=[],e.finalResults=[];var t=window.indexedDB.open(e.dbName);t.onsuccess=function(t){var n=t.target.result,a=n.transaction(["TrainStopTimes"]),i=a.objectStore("TrainStopTimes"),r=i.index("stopIdTrainStopTimes");r.getAll(e.search.dId).onsuccess=function(t){for(r in t.target.result){var n=new Date((new Date).toLocaleDateString()+" "+e.startTime.toLocaleTimeString()),a=new Date((new Date).toLocaleDateString()+" "+t.target.result[r].departureTime);if(a>n){var i=a.getTime()-n.getTime(),o=Math.round(i/6e4);60>o&&e.results.push(t.target.result[r])}}if(0==e.results.length){var s={tripId:" ",departureTime:"There are no available trains for this route in the next 60 minutes",FinalDestArrival:" ",TravelDuration:" "};e.finalResults.push(s),e.$apply()}else c()}}}function c(){var t=window.indexedDB.open(e.dbName);t.onsuccess=function(t){var n=t.target.result,a=n.transaction(["TrainStopTimes"]),r=a.objectStore("TrainStopTimes");for(i in e.results)e.results[i].FinalDestName=e.search.aName,e.results[i].FinalDestId=e.search.aId,e.results[i].FinalDestArrival="",r.index("compound1").get([e.results[i].tripId,e.search.aId]).onsuccess=function(t){for(j in e.results)if(t.target.result.tripId==e.results[j].tripId){e.results[j].FinalDestArrival=t.target.result.arrivalTime;var n=new Date((new Date).toLocaleDateString()+" "+e.results[j].departureTime),a=new Date((new Date).toLocaleDateString()+" "+e.results[j].FinalDestArrival),i=a.getTime()-n.getTime(),r=Math.round(i/6e4);e.results[j].TravelDuration=r,e.finalResults.push(e.results[j]),e.$apply()}};e.$apply()}}function m(e){return new Promise(function(t,n){var a=new XMLHttpRequest;a.open("GET",e),a.onload=function(){200==a.status?t(a.response):n(Error(a.statusText))},a.onerror=function(){n(Error("Network Error"))},a.send()})}function d(t,n){var a=new Date;a.setMinutes(a.getMinutes()+parseInt(S[t].minutes));var i=0;for(index2 in n)if(S[t].block_id==n[index2].block_id){var r=new Date;r.setMinutes(r.getMinutes()+parseInt(n[index2].minutes));var o={tripId:S[t].block_id,departureTime:a.toLocaleTimeString(),FinalDestArrival:r.toLocaleTimeString(),TravelDuration:parseInt(n[index2].minutes)-parseInt(S[t].minutes)};i=1,e.finalResults.push(o),e.$apply()}}function f(){S=[],h=[],e.finalResults=[];var t=(Promise.resolve(),"http://api.metro.net/agencies/lametro/stops/"+e.search.dId+"/predictions/"),n="http://api.metro.net/agencies/lametro/stops/"+e.search.aId+"/predictions/";m(t).then(function(t){S=JSON.parse(t).items,m(n).then(function(t){h=JSON.parse(t).items;for(index in S)d(index,h);if(0==e.finalResults.length){var n={tripId:" ",departureTime:"There are no available trains for this route in the next 90 minutes",FinalDestArrival:" ",TravelDuration:" "};e.finalResults.push(n),e.$apply()}},function(e){alert("Failed! 2")})},function(e){alert("Failed! 1")})}e.globalDate=new Date,e.globalDate.toLocaleTimeString(navigator.language,{hour:"2-digit",minute:"2-digit"}),e.agencyCode="LACMTA",e.trainStops=[],e.trainStopTimes=[],e.results=[],e.dbName="myTrainDb10_in",e.search={},e.stopNames=[],e.toStopNames=[],e.fromStopName="",e.toStopName="",e.startTime=new Date(1970,0,1,(new Date).getHours(),(new Date).getMinutes(),0),e.buttonText="Getting Ready",e.buttonReady=!1,e.online="Offline",e.connectionImg="signal_wifi_off",e.query={order:"name",limit:5,page:1},e.tableText="",e.finalResults=[],navigator.onLine?(e.online="Online",e.connectionImg="signal_wifi_4_bar"):(e.online="Offline",e.connectionImg="signal_wifi_off"),l.addEventListener("offline",function(){e.online="Offline",e.connectionImg="signal_wifi_off",e.$apply(),""!=e.search.dName&&""!=e.search.dId&&""!=e.search.aName&&""!=e.search.aId&&""!=e.search.sTime&&e.searchTrains()},!1),l.addEventListener("online",function(){e.online="Online",e.connectionImg="signal_wifi_4_bar",e.$apply(),""!=e.search.dName&&""!=e.search.dId&&""!=e.search.aName&&""!=e.search.aId&&""!=e.search.sTime&&e.searchTrains()},!1);var T=new Promise(function(e,t){$.getScript("js/data6.js").done(function(){e("Stuff worked!")}).fail(function(){t(Error("It broke"))})});T.then(function(t){e.trainStops=stopsString;for(index in e.trainStops)e.stopNames.push(e.trainStops[index].stopName+"_"+e.trainStops[index].stopId),e.$apply()},function(e){console.log(e)});var g=new Promise(function(e,t){$.getScript("js/data3.js").done(function(){e("Stuff worked!")}).fail(function(){t(Error("It broke"))})});g.then(function(e){p()},function(e){console.log(e)}),e.fromStopNameSelected=function(){var t=0;e.toStopName="";for(index in e.stopNames)e.stopNames[index]==e.fromStopName&&(t=1);if(0==t)e.fromStopName="";else{e.toStopNames=[];for(i in e.trainStops){var n=e.trainStops[i].stopName+"_"+e.trainStops[i].stopId;if(n==e.fromStopName)for(j in e.trainStops[i].children)e.toStopNames.push(e.trainStops[i].children[j].stopName+"_"+e.trainStops[i].children[j].stopId)}}e.$apply()},e.toStopNameSelected=function(){var t=0;for(index in e.stopNames)e.stopNames[index]==e.toStopName&&(t=1);0==t&&(e.toStopName=""),e.$apply()},e.searchTrains=function(){if(e.search={dName:e.fromStopName.split("_")[0],dId:e.fromStopName.split("_")[1],aName:e.toStopName.split("_")[0],aId:e.toStopName.split("_")[1],sTime:e.startTime},"Offline"==e.online&&(e.tableText="Showing offline data - Application Offline",u()),"Online"==e.online){var t=new Date((new Date).toLocaleDateString()+" "+e.startTime.toLocaleTimeString());if(t.getHours()>=e.globalDate.getHours()){var n=t.getTime()-e.globalDate.getTime(),a=Math.round(n/6e4);90>a?(e.tableText="Showing realtime data",f()):(e.tableText="Showing offline data - departure time not in the realtime range(current time + 90 mins)",u())}else e.tableText="Showing offline data - departure time not in the realtime range(current time + 90 mins)",u()}};var S=[],h=[]}]);